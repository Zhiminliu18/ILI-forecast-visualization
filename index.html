<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ILI周数据可视化</title>
    <!-- 先加载 moment.js -->
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <!-- 再加载 Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- 最后加载日期适配器 -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.1/dist/chartjs-adapter-moment.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        #controlPanel {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        #controlPanel label {
            margin-right: 5px;
        }
        #controlPanel select, #controlPanel input {
            padding: 5px;
            margin-right: 10px;
        }
        #controlPanel button {
            padding: 5px 10px;
            background-color: #4bc0c0;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #controlPanel button:hover {
            background-color: #3a9d9d;
        }
        #chartContainer {
            width: 80%;
            max-width: 800px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div id="controlPanel">
        <label for="yearSelect">选择年份:</label>
        <select id="yearSelect"></select>
        <label for="weekSelect">选择周数:</label>
        <select id="weekSelect"></select>
        <label for="rangeInput">前后范围(周):</label>
        <input type="number" id="rangeInput" min="1" max="52" value="20">
        <button onclick="updateChart()">更新图表</button>
    </div>
    <div id="chartContainer">
        <canvas id="iliChart"></canvas>
    </div>

    <script>
        // 全局变量，用于存储加载的数据
        let iliData = [];
        let chart;
        let yearWeekMap = {}; // 声明为全局变量

        const yearSelect = document.getElementById('yearSelect');
        const weekSelect = document.getElementById('weekSelect');
        const rangeInput = document.getElementById('rangeInput');
        const ctx = document.getElementById('iliChart').getContext('2d');

        // 异步加载数据并初始化
        async function initialize() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error(`HTTP错误! 状态码: ${response.status}`);
                }
                iliData = await response.json();
                // console.log("数据加载成功，样本:", iliData.slice(0, 100)); // 打印前100条数据

                // 初始化年份和周数选择器
                yearWeekMap = {};
                iliData.forEach(item => {
                    const date = moment(item.original_date);
                    const year = date.isoWeekYear();
                    const week = date.isoWeek();
                    if (!yearWeekMap[year]) yearWeekMap[year] = new Set();
                    yearWeekMap[year].add(week);
                });

                const availableYears = Object.keys(yearWeekMap).map(Number).sort();
                availableYears.forEach(year => {
                    yearSelect.add(new Option(year, year));
                });
                yearSelect.value = availableYears[0];
                updateWeekOptions();

                yearSelect.addEventListener('change', updateWeekOptions);
            } catch (error) {
                console.error("加载数据失败:", error);
                alert(`数据加载失败: ${error.message}`);
            }
        }

        function updateWeekOptions() {
            const selectedYear = parseInt(yearSelect.value);
            weekSelect.innerHTML = '';
            const weeks = Array.from(yearWeekMap[selectedYear]).sort((a, b) => a - b);
            weeks.forEach(week => {
                weekSelect.add(new Option(week, week));
            });
            weekSelect.value = weeks[0];
        }
        initialize();

        function getStartDate(year, week) {
            // 方法1：使用 isoWeek 并调整为周日
            return moment()
                .isoWeekYear(year)
                .isoWeek(week)
                .startOf('week')      // 先定位到本周第一天（默认周一）
                .add(7, 'days')       // 再加6天到周日
                .format("YYYY-MM-DDTHH:mm:ss");
        }

        function updateChart() {
            const selectedYear = parseInt(yearSelect.value);
            const selectedWeek = parseInt(weekSelect.value);
            const rangeWeeks = parseInt(rangeInput.value);

            try {
                // 计算时间范围
                const startDate = moment(getStartDate(selectedYear, selectedWeek));
                const startRange = startDate.clone().subtract(rangeWeeks, 'weeks');
                const endDate = startDate.clone().add(rangeWeeks, 'weeks');
                console.log("开始日期", startDate);

                // 筛选真实值数据
                const tTrue = iliData.filter(item => {
                    const date = moment(item.date);
                    const originalDate = moment(item.original_date);
                    return date >= startRange && date <= endDate;
                }).reduce((acc, item) => {
                    const key = item.date;
                    if (!acc[key]) acc[key] = { date: item.date, true: item.true };
                    return acc;
                }, {});
                
                const trueData = Object.values(tTrue).sort((a, b) => new Date(a.date) - new Date(b.date));
                
                
                // 筛选预测值数据（仅startDate当周）
                const tPoint = iliData.filter(item => {
                    const originalDate = moment(item.original_date);
                    return originalDate.isSame(startDate, 'day')
                });
                const methods = [...new Set(tPoint.map(item => item.method))];

                // 准备图表数据
                const datasets = [
                    {
                        label: 'True',
                        data: trueData.map(item => ({ x: item.date, y: item.true })),
                        borderColor: 'black',
                        backgroundColor: 'black',
                        pointStyle: 'circle',
                        fill: false
                    }
                ];

                const colors = ['red', 'blue', 'green', 'purple', 'orange'];
                methods.forEach((method, i) => {
                    const methodData = tPoint.filter(item => item.method === method)
                        .map(item => ({ x: item.date, y: item.point }))
                        .sort((a, b) => new Date(a.x) - new Date(b.x));
                    datasets.push({
                        label: `Prediction (${method})`,
                        data: methodData,
                        borderColor: colors[i % colors.length],
                        backgroundColor: colors[i % colors.length],
                        pointStyle: 'cross',
                        borderDash: [5, 5],
                        fill: false
                    });
                });

                // 更新图表
                if (chart) chart.destroy();
                chart = new Chart(ctx, {
                    type: 'line',
                    data: { datasets },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: `ILI 数据趋势 (${startDate.format('YYYY-MM-DD')})`,
                                font: { size: 18 }
                            }
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                parser: 'YYYY-MM-DDTHH:mm:ss', // 匹配你的 ISO 格式
                                tooltipFormat: 'YYYY-MM-DD',   // 提示框显示简略日期
                                unit: 'week',                  // 按周显示
                                displayFormats: {
                                    week: 'YYYY-MM-DD'         // 坐标轴标签格式
                                    }
                                },
                                title: { display: true, text: '日期' }
                            },
                            y: {
                                title: { display: true, text: '值' },
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (e) {
                console.error('绘图时出错:', e);
                alert('绘图时出错，请检查选择的时间范围');
            }
        }

        // 初始渲染
        updateChart();
    </script>
</body>
</html>